<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>東武バス接近情報</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .delayed { color: orange !important; }
    </style>
</head>

<body class="bg-light">
    <script>
        setInterval(() => { window.location.reload(); }, 60000);
    </script>

    <div class="container py-5">

    <marquee bgcolor="#d9d9ff">このページは向原バス停。南柏駅方面行きの接近情報です。電波状況により、表示が乱れたり、表示できない場合がございますので、予めご了承ください。</marquee>
        <div class="text-center mb-4">
            <i class="bi bi-bus-front-fill display-1 text-primary"></i>
            <h1 class="mt-2 fw-bold">向原バス停 接近情報</h1>
            <h3 class="text-secondary">南柏方面</h3>
            <div class="mt-3">
                <span class="badge bg-info text-dark fs-5">
                    現在時刻: <span id="current-time"></span>
                </span>
            <h6 class="text-danger fw-bold">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                遅延・運休情報は反映されません。余裕をもってバス停へお越しください。
            </h6>
            </div>
        </div>

        <div class="row justify-content-center g-4">
            <div class="col-md-6">
                <div class="card mb-3 shadow-sm border-primary">
                    <div class="card-body">
                        <h5 class="mb-3"><i class="bi bi-1-circle text-primary"></i> <span class="fw-bold">今度のバス</span></h5>
                        <h5 class="card-title"></h5>
                        <p class="card-text mb-2">
                            <i class="bi bi-clock-fill me-2 text-secondary"></i>
                            発車時刻 <span class="fw-bold"></span>
                        </p>
                        <div class="fs-4 countdown text-danger fw-bold"></div>
                    </div>
                </div>
                <div class="card mb-3 shadow-sm border-secondary">
                    <div class="card-body">
                        <h5 class="mb-3"><i class="bi bi-2-circle text-secondary"></i> <span class="fw-bold">そのつぎのバス</span></h5>
                        <h5 class="card-title"></h5>
                        <p class="card-text mb-2">
                            <i class="bi bi-clock-fill me-2 text-secondary"></i>
                            発車時刻 <span class="fw-bold"></span>
                        </p>
                        <div class="fs-4 countdown text-secondary fw-bold"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4">
        <p class="text-muted">麗澤大学 工学部</p>
        <p class="text-muted">このページは非公式です。正確な情報は公式サイトをご確認ください。</p>
    </footer>

    <script>
        function updateCurrentTime() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${y}/${m}/${d} ${h}:${min}:${s}`;
        }
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        let countdownIntervals = [];

        async function loadAndRender() {
            try {
                const response = await fetch("/static/timetable.json");
                const data = await response.json();
                renderBusTimes(data);
            } catch (error) {
                console.error("JSON読み込みエラー:", error);
            }
        }

        function renderBusTimes(data) {
            // clear previous intervals
            countdownIntervals.forEach(clearInterval);
            countdownIntervals = [];

            const now = new Date();
            const dayType = (now.getDay() === 0 || now.getDay() === 6) ? "weekend" : "weekday";
            const times = data[dayType];

            const futureTimes = times
                .map(t => {
                    const [hour, minute] = t.time.split(":").map(Number);
                    const busTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);
                    const diffMs = busTime - now;
                    return {
                        ...t,
                        timeObj: busTime,
                        diffMs,
                    };
                })
                .filter(t => t.diffMs > -60000)
                .sort((a, b) => a.diffMs - b.diffMs)
                .slice(0, 2);

            const cards = document.querySelectorAll(".card");
            futureTimes.forEach((t, idx) => {
                const card = cards[idx];
                card.querySelector(".card-title").textContent = `${t.route_name}`;
                card.querySelector(".card-text .fw-bold").textContent = `${t.time}`;

                // 行先表示追加
                card.querySelector(".destination")?.remove();
                const destElem = document.createElement("div");
                destElem.className = "destination text-muted";
                destElem.textContent = `→ ${t.destination}`;
                card.querySelector(".card-body").appendChild(destElem);

                const countdownEl = card.querySelector(".countdown");
                const updateCountdown = () => {
                    const now = new Date();
                    const diffMs = t.timeObj - now;
                    const diffMin = Math.floor(diffMs / 60000);
                    const diffSec = Math.floor((diffMs % 60000) / 1000);

                    if (diffMs <= 0) {
                        countdownEl.textContent = "まもなく発車";
                    } else if (diffMin < 10) {
                        countdownEl.textContent = `${diffMin}分${diffSec}秒後`;
                    } else {
                        countdownEl.textContent = `${diffMin}分後`;
                    }
                };

                updateCountdown();
                const interval = setInterval(updateCountdown, 1000);
                countdownIntervals.push(interval);
            });
        }

        loadAndRender();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>